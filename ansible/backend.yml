- name: Configure Node.js Backend Application
  hosts: all
  become: yes
  
  vars:
    mysql_host: "10.0.0.123"
    mysql_root_password: "ExpenseApp@1"
    backend_zip_url: "https://expense-artifacts.s3.amazonaws.com/backend.zip"
    app_dir: "/app"
    
  handlers:
    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: yes
      
    - name: Restart backend service
      ansible.builtin.systemd:
        name: backend
        state: restarted

  tasks:
    # Node.js Setup
    - name: Disable default Node.js module
      ansible.builtin.command: dnf module disable nodejs -y
      changed_when: false

    - name: Enable Node.js 18 module
      ansible.builtin.command: dnf module enable nodejs:18 -y
      changed_when: false

    - name: Install Node.js
      ansible.builtin.package:
        name: nodejs
        state: present

    # User and Directory Setup
    - name: Create expense user
      ansible.builtin.user:
        name: expense
        system: yes
        create_home: no
        state: present

    - name: Create application directory
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        owner: expense
        group: expense
        mode: '0755'

    # Backend Service Configuration
    - name: Copy backend service file
      ansible.builtin.copy:
        src: backend.service
        dest: /etc/systemd/system/backend.service
        owner: root
        group: root
        mode: '0644'
      notify:
        - Reload systemd daemon
        - Restart backend service

    # Application Deployment
    - name: Download backend application
      ansible.builtin.get_url:
        url: "{{ backend_zip_url }}"
        dest: /tmp/backend.zip
        mode: '0644'

    - name: Clean application directory
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: absent
      register: cleaned_dir

    - name: Recreate application directory
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        owner: expense
        group: expense
        mode: '0755'
      when: cleaned_dir.changed

    - name: Extract backend application
      ansible.builtin.unarchive:
        src: /tmp/backend.zip
        dest: "{{ app_dir }}"
        remote_src: yes
        owner: expense
        group: expense
        creates: "{{ app_dir }}/package.json"

    # Node.js Dependencies
    - name: Install Node.js dependencies
      ansible.builtin.shell: |
        cd {{ app_dir }} && npm install
      args:
        executable: /bin/bash
        chdir: "{{ app_dir }}"
        creates: "{{ app_dir }}/node_modules"
      environment:
        NODE_ENV: production

    # MySQL Client Installation
    - name: Install MySQL client
      ansible.builtin.package:
        name: mysql
        state: present

    # Database Schema Setup
    - name: Check if database already exists
      ansible.builtin.shell: |
        mysql -h {{ mysql_host }} -uroot -p{{ mysql_root_password }} -e "SHOW DATABASES;" | grep -q expense
      register: db_exists
      changed_when: false
      failed_when: false
      ignore_errors: yes

    - name: Load database schema
      ansible.builtin.shell: |
        mysql -h {{ mysql_host }} -uroot -p{{ mysql_root_password }} < {{ app_dir }}/schema/backend.sql
      when: not db_exists.rc == 0
      register: schema_load_result
      failed_when: false

    # Service Management
    - name: Reload systemd daemon (explicit)
      ansible.builtin.systemd:
        daemon_reload: yes
      changed_when: false

    - name: Enable backend service
      ansible.builtin.systemd:
        name: backend
        enabled: yes

    - name: Start backend service
      ansible.builtin.systemd:
        name: backend
        state: started

    # Verification
    - name: Check backend service status
      ansible.builtin.systemd:
        name: backend
        state: started
      register: service_status

    - name: Display setup completion
      ansible.builtin.debug:
        msg: |
          Backend application deployed successfully!
          Application directory: {{ app_dir }}
          Service: backend
          MySQL host: {{ mysql_host }}